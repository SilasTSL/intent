<% layout('layouts/boilerplate') %>
<div class="rows">
    <h1 class="text-center mt-5">Edit Lesson</h1>
    <div class="col-6 offset-3">
        <form id="editLessonForm" method="POST" action="/timetable/<%= lesson._id %>?_method=PUT">
            <div class="mb-3">
                <label class="form-label" for="title">Title</label>
                <input class="form-control" type="text" id="title" name="lesson[title]" value="<%= lesson.title %>" required>
                <div class="valid-feedback">Looks good!</div>
            </div>
            <div class="mb-4">
                <label class="form-label" for="colour">Colour</label>
                <select class="form-select" id="colour" name="lesson[colour]" required>
                    <option value="" selected disabled>Select a colour</option>
                    <option value="#C62828" <% if (lesson.colour === "#C62828") { %> selected <% } %>>Red</option>
                    <option value="#1565C0" <% if (lesson.colour === "#1565C0") { %> selected <% } %>>Blue</option>
                    <option value="#2E7D32" <% if (lesson.colour === "#2E7D32") { %> selected <% } %>>Green</option>
                    <option value="#FFA000" <% if (lesson.colour === "#FFA000") { %> selected <% } %>>Yellow</option>
                    <option value="#6A1B9A" <% if (lesson.colour === "#6A1B9A") { %> selected <% } %>>Purple</option>
                    <option value="#F08731" <% if (lesson.colour === "#F08731") { %> selected <% } %>>Orange</option>
                </select>
                <div class="valid-feedback">Looks good!</div>
            </div>
            <div id="timingContainer" class="mb-3" style="display: flex; flex-direction: column; align-items: start;">
                <% for (let i = 0; i < lesson.timings.length; i++) { %>
                    <div class="timing-row mb-3">
                        <div class="mb-2">
                            <label class="form-label" for="day<%= i %>">Day</label>
                            <select class="form-select" id="day<%= i %>" name="lesson[timings][<%= i %>][day]" required>
                                <option value="" selected disabled>Select a day</option>
                                <option value="Monday" <% if (lesson.timings[i].day === "Monday") { %> selected <% } %>>Monday</option>
                                <option value="Tuesday" <% if (lesson.timings[i].day === "Tuesday") { %> selected <% } %>>Tuesday</option>
                                <option value="Wednesday" <% if (lesson.timings[i].day === "Wednesday") { %> selected <% } %>>Wednesday</option>
                                <option value="Thursday" <% if (lesson.timings[i].day === "Thursday") { %> selected <% } %>>Thursday</option>
                                <option value="Friday" <% if (lesson.timings[i].day === "Friday") { %> selected <% } %>>Friday</option>
                            </select>
                            <div class="valid-feedback">Looks good!</div>
                        </div>
                        <div class="mb-2">
                            <label class="form-label" for="timingStart<%= i %>">Timing Start</label>
                            <input class="form-control" type="text" id="timingStart<%= i %>" name="lesson[timings][<%= i %>][timingStart]" value="<%= lesson.timings[i].timingStart %>" required>
                            <div class="valid-feedback">Looks good!</div>
                        </div>
                        <div class="mb-2">
                            <label class="form-label" for="timingEnd<%= i %>">Timing End</label>
                            <input class="form-control" type="text" id="timingEnd<%= i %>" name="lesson[timings][<%= i %>][timingEnd]" value="<%= lesson.timings[i].timingEnd %>" required>
                            <div class="valid-feedback">Looks good!</div>
                        </div>
                        <button type="button" class="btn btn-danger deleteTimingButton" data-index="<%= i %>">Delete Timing</button>
                    </div>
                <% } %>
            </div>
            <div class="mb-3">
                <button type="button" class="btn btn-success addTimingButton">Add Timing</button>
            </div>
            <div class="d-flex justify-content-between mt-4">
                <a href="/timetable" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <button class="btn btn-danger" style="height: 100%;" id="deleteLessonButton">Delete Lesson</button>
            </div>
        </form>

    </div>
</div>

<script>
    // Function to create a new timing row
    function createTimingRow(index) {
        const timingRow = document.createElement('div');
        timingRow.classList.add('timing-row', 'mb-3');
        timingRow.innerHTML = `
            <div class="mb-2">
                <label class="form-label" for="day${index}">Day</label>
                <select class="form-select" id="day${index}" name="lesson[timings][${index}][day]" required>
                    <option value="" selected disabled>Select a day</option>
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday">Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                </select>
                <div class="valid-feedback">Looks good!</div>
            </div>
            <div class="mb-2">
                <label class="form-label" for="timingStart${index}">Timing Start</label>
                <input class="form-control" type="text" id="timingStart${index}" name="lesson[timings][${index}][timingStart]" required>
                <div class="valid-feedback">Looks good!</div>
            </div>
            <div class="mb-2">
                <label class="form-label" for="timingEnd${index}">Timing End</label>
                <input class="form-control" type="text" id="timingEnd${index}" name="lesson[timings][${index}][timingEnd]" required>
                <div class="valid-feedback">Looks good!</div>
            </div>
            <button type="button" class="btn btn-danger deleteTimingButton" data-index="${index}">Delete Timing</button>
        `;
        return timingRow;
    }

    // Function to handle the click event of the Add Timing button
    function addTiming() {
        const timingContainer = document.getElementById('timingContainer');
        const timingRows = timingContainer.getElementsByClassName('timing-row');
        const index = timingRows.length;
        const newTimingRow = createTimingRow(index);
        timingContainer.appendChild(newTimingRow);
        newTimingRow.getElementsByClassName("deleteTimingButton")[0].addEventListener('click', deleteTiming);
    }

    // Function to handle the click event of the Delete Timing button
    function deleteTiming(event) {
        const timingContainer = document.getElementById('timingContainer');
        const timingRows = timingContainer.getElementsByClassName('timing-row');
        const index = event.target.getAttribute('data-index');
        if (index <= timingRows.length && timingRows.length > 1) {
            timingContainer.removeChild(timingRows[index]);
            return;
        }

        // Check if the last timing row is deleted
        if (timingRows.length === 1) {
            if (confirm("Are you sure you want to delete this weekly task?")) {
                document.getElementById('editLessonForm').action = "/timetable/<%= lesson._id %>?_method=DELETE";
                document.getElementById('editLessonForm').submit();
            }
        }
    }

    const deleteLessonButton = document.getElementById('deleteLessonButton');
    deleteLessonButton.addEventListener('click', () => {
        if (confirm("Are you sure you want to delete this weekly task?")) {
            document.getElementById('editLessonForm').action = "/timetable/<%= lesson._id %>?_method=DELETE";
            document.getElementById('editLessonForm').submit();
        }
    });

    // Add event listener for the Add Timing button
    const addTimingButton = document.querySelector('.addTimingButton');
    addTimingButton.addEventListener('click', addTiming);

    // Add event listener for the Delete Timing buttons
    const deleteTimingButtons = document.getElementsByClassName('deleteTimingButton');
    Array.from(deleteTimingButtons).forEach((button) => {
        button.addEventListener('click', deleteTiming);
    });

    // Function to check for timing conflicts with existing timings
    function checkTimingConflicts() {
        // Get the form element
        const form = document.getElementById('editLessonForm');

        // Get the timing rows
        const timingRows = Array.from(document.getElementsByClassName('timing-row'));

        // Get the values of the submitted timings
        const submittedTimings = timingRows.map((row) => ({
            day: row.querySelector('select[name^="lesson[timings]"][name$="[day]"]').value,
            timingStart: row.querySelector('input[name^="lesson[timings]"][name$="[timingStart]"]').value,
            timingEnd: row.querySelector('input[name^="lesson[timings]"][name$="[timingEnd]"]').value
        }));

        function doTimingsConflict(timingA, timingB) {
            // Compare the properties of timingA and timingB to check for conflicts
            // Implement your conflict checking logic here
            
            // Example conflict checking logic:
            return (
                timingA.day === timingB.day &&
                timingA.timingStart < timingB.timingEnd &&
                timingA.timingEnd > timingB.timingStart
            );
        }

        internalConflict = false;
        // Nested loops to compare each timing with all other timings
        for (let i = 0; i < submittedTimings.length; i++) {
            for (let j = i + 1; j < submittedTimings.length; j++) {
                const timingA = submittedTimings[i];
                const timingB = submittedTimings[j];
                
                // Check for conflicts between timingA and timingB
                if (doTimingsConflict(timingA, timingB)) {
                    internalConflict = true;
                }
            }
        }

        if (internalConflict) {
            alert('The submitted timings conflict with other timings of the current lesson.');
            return false;
        }



        // Get the existing timings from the server-side parameter
        const existingUnitTimings = JSON.parse('<%- JSON.stringify(existingTimingsList) %>');
        console.log("DSAD")
        console.log(existingUnitTimings)
        // Function to check for conflicts
        function hasConflict(submittedTiming) {
            return existingUnitTimings.some((existingTiming) => {
                const existingStart = existingTiming.timingStart;
                const existingEnd = existingTiming.timingEnd;
                return (
                    (submittedTiming.timingStart >= existingStart && submittedTiming.timingStart < existingEnd) ||
                    (submittedTiming.timingEnd > existingStart && submittedTiming.timingEnd <= existingEnd) ||
                    (submittedTiming.timingStart <= existingStart && submittedTiming.timingEnd >= existingEnd)
                ) && submittedTiming.day === existingTiming.day;
            });
        }

        // Filter out the existing timings from the submitted timings
        const filteredSubmittedTimings = submittedTimings.filter((submittedTiming) => {
            return !existingUnitTimings.some((existingTiming) => {
                return (
                    submittedTiming.day === existingTiming.day &&
                    submittedTiming.timingStart === existingTiming.timingStart &&
                    submittedTiming.timingEnd === existingTiming.timingEnd
                );
            });
        });

        // Check for conflicts only among the filtered submitted timings
        const hasConflicts = filteredSubmittedTimings.some(hasConflict);

        // If conflicts are found, display an alert and prevent form submission
        if (hasConflicts) {
            alert('The submitted timings conflict with existing timings.');
            return false; // Prevent form submission
        }

        // If no conflicts are found, allow form submission
        return true;
    }

    // Add event listener to the form submit event
    const editLessonForm = document.getElementById('editLessonForm');
    editLessonForm.addEventListener('submit', (event) => {
        const isFormValid = checkTimingConflicts();

        if (!isFormValid) {
            event.preventDefault(); // Prevent form submission if there are conflicts
        }
    });
</script>